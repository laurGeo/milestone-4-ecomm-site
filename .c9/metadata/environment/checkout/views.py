{"changed":true,"filter":false,"title":"views.py","tooltip":"/checkout/views.py","value":"from django.shortcuts import render, get_object_or_404, reverse, redirect\nfrom django.contrib.auth.decorators import login_required\nfrom django.contrib import messages\nfrom .forms import MakePaymentForm, OrderForm\nfrom .models import OrderLineItem\nfrom django.conf import settings\nfrom django.utils import timezone\nfrom products.models import Product\nimport stripe\n\n\n# Create your views here.\n\nstripe.api_key = settings.STRIPE_SECRET\n\"\"\" Only for authenticated users\"\"\"\n@login_required()\ndef checkout(request):\n    if request.method==\"POST\":\n        order_form = OrderForm(request.POST)\n        payment_form = MakePaymentForm(request.POST)\n\n        if order_form.is_valid() and payment_form.is_valid():\n            order = order_form.save(commit=False)\n            order.date = timezone.now()\n            order.save()\n            \n            cart = request.session.get('cart', {})\n            total = 0\n            for id, quantity in cart.items():\n                product = get_object_or_404(Product, pk=id)\n                total += quantity * product.price\n                order_line_item = OrderLineItem(\n                    order = order, \n                    product = product, \n                    quantity = quantity\n                    )\n                order_line_item.save()\n                \n            try:\n                customer = stripe.Charge.create(\n                    amount = int(total * 100),\n                    currency = \"EUR\",\n                    description = request.user.email,\n                    card = payment_form.cleaned_data['stripe_id'],\n                )\n            except stripe.error.CardError:\n                messages.error(request, \"Your card was declined!\")\n                \n            if customer.paid:\n                messages.error(request, \"You have successfully paid\")\n                request.session['cart'] = {}\n                return redirect(reverse('products'))\n            else:\n                messages.error(request, \"Unable to take payment\")\n        else:\n            print(payment_form.errors)\n            messages.error(request, \"We were unable to take a payment with that card!\")\n    else:\n        payment_form = MakePaymentForm()\n        order_form = OrderForm()\n        \n    return render(request, \"checkout.html\", {'order_form': order_form, 'payment_form': payment_form, 'publishable': settings.STRIPE_PUBLISHABLE})\n    ","undoManager":{"mark":19,"position":20,"stack":[[{"start":{"row":16,"column":22},"end":{"row":17,"column":0},"action":"insert","lines":["",""],"id":2},{"start":{"row":17,"column":0},"end":{"row":17,"column":4},"action":"insert","lines":["    "]},{"start":{"row":17,"column":4},"end":{"row":17,"column":5},"action":"insert","lines":["p"]},{"start":{"row":17,"column":5},"end":{"row":17,"column":6},"action":"insert","lines":["r"]},{"start":{"row":17,"column":6},"end":{"row":17,"column":7},"action":"insert","lines":["i"]},{"start":{"row":17,"column":7},"end":{"row":17,"column":8},"action":"insert","lines":["n"]},{"start":{"row":17,"column":8},"end":{"row":17,"column":9},"action":"insert","lines":["t"]}],[{"start":{"row":17,"column":9},"end":{"row":17,"column":11},"action":"insert","lines":["()"],"id":3}],[{"start":{"row":17,"column":10},"end":{"row":17,"column":11},"action":"insert","lines":["r"],"id":4},{"start":{"row":17,"column":11},"end":{"row":17,"column":12},"action":"insert","lines":["e"]},{"start":{"row":17,"column":12},"end":{"row":17,"column":13},"action":"insert","lines":["q"]},{"start":{"row":17,"column":13},"end":{"row":17,"column":14},"action":"insert","lines":["u"]},{"start":{"row":17,"column":14},"end":{"row":17,"column":15},"action":"insert","lines":["e"]},{"start":{"row":17,"column":15},"end":{"row":17,"column":16},"action":"insert","lines":["s"]},{"start":{"row":17,"column":16},"end":{"row":17,"column":17},"action":"insert","lines":["t"]}],[{"start":{"row":17,"column":18},"end":{"row":17,"column":19},"action":"insert","lines":[";"],"id":5}],[{"start":{"row":17,"column":18},"end":{"row":17,"column":19},"action":"remove","lines":[";"],"id":6}],[{"start":{"row":21,"column":0},"end":{"row":21,"column":4},"action":"insert","lines":["    "],"id":7}],[{"start":{"row":21,"column":4},"end":{"row":21,"column":5},"action":"insert","lines":["p"],"id":8}],[{"start":{"row":21,"column":4},"end":{"row":21,"column":5},"action":"remove","lines":["p"],"id":9}],[{"start":{"row":21,"column":4},"end":{"row":21,"column":8},"action":"insert","lines":["    "],"id":10}],[{"start":{"row":21,"column":8},"end":{"row":21,"column":9},"action":"insert","lines":["p"],"id":11},{"start":{"row":21,"column":9},"end":{"row":21,"column":10},"action":"insert","lines":["r"]},{"start":{"row":21,"column":10},"end":{"row":21,"column":11},"action":"insert","lines":["i"]},{"start":{"row":21,"column":11},"end":{"row":21,"column":12},"action":"insert","lines":["n"]},{"start":{"row":21,"column":12},"end":{"row":21,"column":13},"action":"insert","lines":["t"]}],[{"start":{"row":21,"column":13},"end":{"row":21,"column":14},"action":"insert","lines":[" "],"id":12},{"start":{"row":21,"column":14},"end":{"row":21,"column":15},"action":"insert","lines":["o"]}],[{"start":{"row":21,"column":14},"end":{"row":21,"column":15},"action":"remove","lines":["o"],"id":13},{"start":{"row":21,"column":13},"end":{"row":21,"column":14},"action":"remove","lines":[" "]}],[{"start":{"row":21,"column":13},"end":{"row":21,"column":15},"action":"insert","lines":["()"],"id":14}],[{"start":{"row":21,"column":14},"end":{"row":21,"column":15},"action":"insert","lines":["o"],"id":15},{"start":{"row":21,"column":15},"end":{"row":21,"column":16},"action":"insert","lines":["r"]},{"start":{"row":21,"column":16},"end":{"row":21,"column":17},"action":"insert","lines":["d"]},{"start":{"row":21,"column":17},"end":{"row":21,"column":18},"action":"insert","lines":["e"]},{"start":{"row":21,"column":18},"end":{"row":21,"column":19},"action":"insert","lines":["r"]},{"start":{"row":21,"column":19},"end":{"row":21,"column":20},"action":"insert","lines":["_"]},{"start":{"row":21,"column":20},"end":{"row":21,"column":21},"action":"insert","lines":["f"]},{"start":{"row":21,"column":21},"end":{"row":21,"column":22},"action":"insert","lines":["o"]},{"start":{"row":21,"column":22},"end":{"row":21,"column":23},"action":"insert","lines":["r"]},{"start":{"row":21,"column":23},"end":{"row":21,"column":24},"action":"insert","lines":["m"]}],[{"start":{"row":21,"column":25},"end":{"row":22,"column":0},"action":"insert","lines":["",""],"id":16},{"start":{"row":22,"column":0},"end":{"row":22,"column":8},"action":"insert","lines":["        "]},{"start":{"row":22,"column":8},"end":{"row":22,"column":9},"action":"insert","lines":["r"]}],[{"start":{"row":22,"column":8},"end":{"row":22,"column":9},"action":"remove","lines":["r"],"id":17}],[{"start":{"row":22,"column":8},"end":{"row":22,"column":9},"action":"insert","lines":["p"],"id":18},{"start":{"row":22,"column":9},"end":{"row":22,"column":10},"action":"insert","lines":["r"]},{"start":{"row":22,"column":10},"end":{"row":22,"column":11},"action":"insert","lines":["i"]},{"start":{"row":22,"column":11},"end":{"row":22,"column":12},"action":"insert","lines":["n"]},{"start":{"row":22,"column":12},"end":{"row":22,"column":13},"action":"insert","lines":["t"]}],[{"start":{"row":22,"column":13},"end":{"row":22,"column":15},"action":"insert","lines":["()"],"id":19}],[{"start":{"row":22,"column":14},"end":{"row":22,"column":15},"action":"insert","lines":["p"],"id":20},{"start":{"row":22,"column":15},"end":{"row":22,"column":16},"action":"insert","lines":["a"]},{"start":{"row":22,"column":16},"end":{"row":22,"column":17},"action":"insert","lines":["y"]}],[{"start":{"row":22,"column":14},"end":{"row":22,"column":17},"action":"remove","lines":["pay"],"id":21},{"start":{"row":22,"column":14},"end":{"row":22,"column":26},"action":"insert","lines":["payment_form"]}],[{"start":{"row":9,"column":0},"end":{"row":10,"column":0},"action":"remove","lines":["",""],"id":22}]]},"ace":{"folds":[],"scrolltop":68,"scrollleft":0,"selection":{"start":{"row":9,"column":0},"end":{"row":9,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":2,"state":"start","mode":"ace/mode/python"}},"timestamp":1574201353296}